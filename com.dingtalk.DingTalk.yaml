id: com.dingtalk.DingTalk
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: dingtalk
separate-locales: false

finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
  # Notification
  - --talk-name=org.freedesktop.Notifications
  # System tray icon
  - --own-name=org.kde.*
  # File system
  - --filesystem=xdg-download
  - --filesystem=xdg-run/pipewire-0:ro

cleanup:
  - /include
  - /lib/pkgconfig
  - /libexec
  - /share/doc
  - /share/licenses
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - name: execstack
    buildsystem: simple
    build-commands:
      - bsdtar -xf execstack.rpm
      - install -Dpsm755 -t ${FLATPAK_DEST}/bin usr/bin/execstack
    sources:
      - type: file
        only-arches:
          - x86_64
        url: https://dl.fedoraproject.org/pub/fedora/linux/releases/42/Everything/x86_64/os/Packages/e/execstack-0.5.0-30.fc42.x86_64.rpm
        sha256: e5f9ec5c5c7dffe90a93310e992878da5e7ac2474a46684d0b7edfdc93a80017
        dest-filename: execstack.rpm
      - type: file
        only-arches:
          - aarch64
        url: https://dl.fedoraproject.org/pub/fedora/linux/releases/42/Everything/aarch64/os/Packages/e/execstack-0.5.0-30.fc42.aarch64.rpm
        sha256: 2f7eb87beeae911e36734960be3047878b39e349aab961bce282836a37418307
        dest-filename: execstack.rpm
  - name: libxcrypt
    buildsystem: autotools
    make-install-args:
      - PREFIX=/app
    sources:
      - type: git
        url: https://github.com/besser82/libxcrypt.git
        tag: v4.5.2
        commit: db70b42bd7b2a5b00a8580c8dec0aa66791c950a
        x-checker-data:
          type: git
          url: https://api.github.com/repos/besser82/libxcrypt/releases/latest
          tag-query: .tag_name
  - name: dingtalk
    buildsystem: simple
    build-commands:
      - install -Dpm755 apply_extra ${FLATPAK_DEST}/bin/apply_extra
      - install -Dpm755 dingtalk.sh $FLATPAK_DEST/bin/dingtalk
      - install -Dpm644 com.dingtalk.DingTalk.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
      - install -Dpm644 com.dingtalk.DingTalk.png -t ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps
      - install -Dpm644 com.dingtalk.DingTalk.desktop -t ${FLATPAK_DEST}/share/applications
    sources:
      - type: script
        commands:
          - bsdtar -O -xf dingtalk.deb data.* | bsdtar --no-same-owner -xf -
          - mv opt/apps/com.alibabainc.dingtalk/files dingtalk
          - rm -rf dingtalk/*-Release.*/{libGLdispatch.so*,libGLX.so*,libm.so*,libstdc++.so*,libcurl.so*,libz.so*,Resources/qss/mac}
          - rm -rf dingtalk.deb usr opt
          - execstack -c dingtalk/*-Release.*/{dingtalk_dll,libconference_new}.so
        dest-filename: apply_extra

      - type: file
        path: dingtalk.sh

      - type: file
        path: com.dingtalk.DingTalk.metainfo.xml

      - type: file
        path: com.dingtalk.DingTalk.png

      - type: file
        path: com.dingtalk.DingTalk.desktop

      - type: extra-data
        filename: dingtalk.deb
        only-arches: [x86_64]
        url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_7.8.15.5102301_amd64.deb
        sha256: f0f604a3e5488dcf8bb1bf5006a3c21859c6dfeaf7795b833a5fc40620390f4c
        size: 372399996
        x-checker-data:
          type: rotating-url
          url: https://www.dingtalk.com/win/d/qd=linux_amd64
          pattern: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_([0-9.]+)_amd64.deb

      - type: extra-data
        filename: dingtalk.deb
        only-arches: [aarch64]
        url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_7.8.15.5102301_arm64.deb
        sha256: 7f82405ca1b7f47560f3d4b25aa9eb02058a0f712196d49c6e4dc888a52aa6fb
        size: 374792312
        x-checker-data:
          type: rotating-url
          url: https://www.dingtalk.com/win/d/qd=linux_arm64
          pattern: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_([0-9.]+)_arm64.deb
