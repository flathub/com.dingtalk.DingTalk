id: com.dingtalk.DingTalk
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: dingtalk
separate-locales: false

finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
  # Notification
  - --talk-name=org.freedesktop.Notifications
  # System tray icon
  - --own-name=org.kde.*
  # File system
  - --filesystem=xdg-download
  - --filesystem=xdg-run/pipewire-0:ro

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - name: execstack
    buildsystem: simple
    build-commands:
      - bsdtar -xf execstack.rpm
      - install -Dpsm755 -t ${FLATPAK_DEST}/bin usr/bin/execstack
    sources:
      - type: file
        only-arches:
          - x86_64
        url: https://dl.fedoraproject.org/pub/fedora/linux/releases/42/Everything/x86_64/os/Packages/e/execstack-0.5.0-30.fc42.x86_64.rpm
        sha256: e5f9ec5c5c7dffe90a93310e992878da5e7ac2474a46684d0b7edfdc93a80017
        dest-filename: execstack.rpm
      - type: file
        only-arches:
          - aarch64
        url: https://dl.fedoraproject.org/pub/fedora/linux/releases/42/Everything/aarch64/os/Packages/e/execstack-0.5.0-30.fc42.aarch64.rpm
        sha256: 2f7eb87beeae911e36734960be3047878b39e349aab961bce282836a37418307
        dest-filename: execstack.rpm
  - name: libxcrypt
    buildsystem: autotools
    make-install-args:
      - PREFIX=/app
    sources:
      - type: git
        url: https://github.com/besser82/libxcrypt.git
        tag: v4.4.38
        commit: 55ea777e8d567e5e86ffac917c28815ac54cc341
        x-checker-data:
          type: git
          url: https://api.github.com/repos/besser82/libxcrypt/releases/latest
          tag-query: .tag_name

  - name: dingtalk
    buildsystem: simple
    build-commands:
      - install -Dpm755 apply_extra ${FLATPAK_DEST}/bin/apply_extra
      - install -Dpm755 dingtalk.sh $FLATPAK_DEST/bin/dingtalk
      - install -Dpm644 com.dingtalk.DingTalk.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
      - install -Dpm644 com.dingtalk.DingTalk.png -t ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps
      - install -Dpm644 com.dingtalk.DingTalk.desktop -t ${FLATPAK_DEST}/share/applications
    sources:
      - type: script
        commands:
          - bsdtar -O -xf dingtalk.deb data.* | bsdtar --no-same-owner -xf -
          - mv opt/apps/com.alibabainc.dingtalk/files dingtalk
          - rm -rf dingtalk/*-Release.*/{libGLdispatch.so*,libGLX.so*,libm.so*,libstdc++.so*,libcurl.so*,libz.so*,Resources/qss/mac}
          - rm -rf dingtalk.deb usr opt
          - execstack -c dingtalk/*-Release.*/{dingtalk_dll,libconference_new}.so
        dest-filename: apply_extra

      - type: file
        path: dingtalk.sh

      - type: file
        path: com.dingtalk.DingTalk.metainfo.xml

      - type: file
        path: com.dingtalk.DingTalk.png

      - type: file
        path: com.dingtalk.DingTalk.desktop

      - type: extra-data
        filename: dingtalk.deb
        only-arches: [x86_64]
        url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_7.8.15.5092302_amd64.deb
        sha256: 2a0a72b334bad64c54acadef4eff53cbe6587e9d3c088b57da26cdfbf01a451b
        size: 372346568
        x-checker-data:
          type: json
          url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Update/other/amd64/linux_dingtalk_update_package_gray.json
          version-query: .install.package.version | sub("-Release"; "")
          url-query: .install.package.url

      - type: extra-data
        filename: dingtalk.deb
        only-arches: [aarch64]
        url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Release/com.alibabainc.dingtalk_7.8.15.5092302_arm64.deb
        sha256: 9cd012e616b79d384a85ccdec62ab8c976f0fa0354747dd691cffa9aba4ff9df
        size: 374781200
        x-checker-data:
          type: json
          url: https://dtapp-pub.dingtalk.com/dingtalk-desktop/xc_dingtalk_update/linux_deb/Update/other/amd64/linux_dingtalk_update_package_gray.json
          version-query: .install.package.version | sub("-Release"; "")
          url-query: .install.package.url | sub("amd64"; "arm64")
